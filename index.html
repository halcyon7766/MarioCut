<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MarioCut</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
        }
        #result-container {
            transition: all 0.3s ease-in-out;
        }
        .aspect-w-16 {
            position: relative;
            padding-bottom: 56.25%; /* 16:9 */
        }
        /* お気に入りスターのスタイル */
        .favorite-star {
            cursor: pointer;
            font-size: 1.5rem;
            color: #d1d5db; /* gray-300 */
            transition: color 0.2s, transform 0.2s;
        }
        .favorite-star.active {
            color: #f59e0b; /* amber-500 */
            transform: scale(1.2);
        }
        .favorite-star:hover {
            transform: scale(1.2);
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 md:p-8 max-w-5xl">
        
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-blue-600">MarioCut</h1>
            <p class="text-gray-600 mt-2">出発地と目的地でショートカットを絞り込み検索！</p>
        </header>

        <main class="bg-white p-6 sm:p-8 rounded-2xl shadow-lg">
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                <div>
                    <label for="course-select" class="block text-sm font-medium text-gray-700 mb-2">出発地</label>
                    <select id="course-select" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                        <option value="">出発地を選択</option>
                    </select>
                </div>
                <div>
                    <label for="destination-select" class="block text-sm font-medium text-gray-700 mb-2">目的地</label>
                    <select id="destination-select" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                        <option value="">目的地を選択</option>
                    </select>
                </div>
            </div>

            <div class="flex flex-wrap justify-center gap-4 mb-8">
                <button id="favorites-button" class="px-5 py-2 bg-amber-500 text-white font-semibold rounded-lg hover:bg-amber-600 transition shadow">⭐ お気に入りのみ表示</button>
                <button id="random-button" class="px-5 py-2 bg-teal-500 text-white font-semibold rounded-lg hover:bg-teal-600 transition shadow">🎲 ランダムに表示</button>
                <button id="reset-button" class="px-5 py-2 bg-gray-600 text-white font-semibold rounded-lg hover:bg-gray-700 transition shadow">リセット</button>
            </div>

            <div id="result-container" class="bg-gray-50 p-6 rounded-lg min-h-[200px] flex items-center justify-center">
                <p id="result-placeholder" class="text-gray-500 text-center">ここに選択したショートカットの情報が表示されます。</p>
                <div id="result-content" class="hidden w-full space-y-8">
                    <!-- ショートカットがここに挿入されます -->
                </div>
            </div>

        </main>

        <footer class="text-center mt-8 text-sm text-gray-500">
            <p>&copy; 2025 halcyon7766</p>
        </footer>
    </div>

    <script>
        // --- DOM要素の取得 ---
        const courseSelect = document.getElementById('course-select');
        const destinationSelect = document.getElementById('destination-select');
        const resultPlaceholder = document.getElementById('result-placeholder');
        const resultContent = document.getElementById('result-content');
        const resetButton = document.getElementById('reset-button');
        const favoritesButton = document.getElementById('favorites-button');
        const randomButton = document.getElementById('random-button');

        // --- グローバル変数 ---
        let shortcutData = [];
        let allCourses = [];
        let allDestinations = [];
        let favorites = [];
        let videoObserver;

        // --- 初期化処理 ---
        document.addEventListener('DOMContentLoaded', async () => {
            loadFavorites();
            setupVideoObserver();
            
            try {
                const response = await fetch('/MarioCut/shortcuts.json');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                shortcutData = await response.json();

                const courseSet = new Set();
                const destinationSet = new Set();
                shortcutData.forEach(course => {
                    courseSet.add(course.course);
                    course.shortcuts.forEach(shortcut => {
                        destinationSet.add(shortcut.name);
                    });
                });

                allCourses = Array.from(courseSet).sort((a, b) => a.localeCompare(b, 'ja'));
                allDestinations = Array.from(destinationSet).sort((a, b) => a.localeCompare(b, 'ja'));

                populateSelect(courseSelect, allCourses, "出発地を選択");
                populateSelect(destinationSelect, allDestinations, "目的地を選択");

            } catch (error) {
                console.error('ショートカットデータの読み込みに失敗しました:', error);
                resultPlaceholder.textContent = 'エラー: shortcuts.jsonの読み込みに失敗しました。';
            }
            
            courseSelect.addEventListener('change', handleCourseChange);
            destinationSelect.addEventListener('change', handleDestinationChange);
            resetButton.addEventListener('click', handleReset);
            favoritesButton.addEventListener('click', handleShowFavorites);
            randomButton.addEventListener('click', handleShowRandom);
        });

        // --- イベントハンドラ関数 ---

        function handleCourseChange() {
            const selectedCourse = courseSelect.value;
            if (selectedCourse) {
                const courseData = shortcutData.find(data => data.course === selectedCourse);
                const destinations = courseData ? courseData.shortcuts.map(s => s.name).sort((a, b) => a.localeCompare(b, 'ja')) : [];
                populateSelect(destinationSelect, destinations, "目的地を選択");
            } else {
                populateSelect(destinationSelect, allDestinations, "目的地を選択");
            }
            filterAndDisplayResults();
        }

        function handleDestinationChange() {
            const selectedDestination = destinationSelect.value;
            if (selectedDestination) {
                const relevantCourses = shortcutData
                    .filter(course => course.shortcuts.some(s => s.name === selectedDestination))
                    .map(course => course.course)
                    .sort((a, b) => a.localeCompare(b, 'ja'));
                populateSelect(courseSelect, relevantCourses, "出発地を選択");
            } else {
                populateSelect(courseSelect, allCourses, "出発地を選択");
            }
            filterAndDisplayResults();
        }

        function handleReset() {
            populateSelect(courseSelect, allCourses, "出発地を選択");
            populateSelect(destinationSelect, allDestinations, "目的地を選択");
            courseSelect.value = "";
            destinationSelect.value = "";
            hideResult();
        }

        function handleShowFavorites() {
            handleReset(); // 他の選択をクリア
            const favoriteShortcuts = [];
            shortcutData.forEach(course => {
                course.shortcuts.forEach(shortcut => {
                    const id = `${course.course}-${shortcut.name}`;
                    if (favorites.includes(id)) {
                        favoriteShortcuts.push({ ...shortcut, courseName: course.course });
                    }
                });
            });
            displayAllResults(favoriteShortcuts);
        }

        function handleShowRandom() {
            handleReset(); // 他の選択をクリア
            const allShortcuts = [];
            shortcutData.forEach(course => {
                course.shortcuts.forEach(shortcut => {
                    allShortcuts.push({ ...shortcut, courseName: course.course });
                });
            });

            if (allShortcuts.length > 0) {
                const randomIndex = Math.floor(Math.random() * allShortcuts.length);
                displayAllResults([allShortcuts[randomIndex]]);
            }
        }

        // --- お気に入り機能 ---
        function loadFavorites() {
            favorites = JSON.parse(localStorage.getItem('marioCutFavorites')) || [];
        }

        function saveFavorites() {
            localStorage.setItem('marioCutFavorites', JSON.stringify(favorites));
        }

        function toggleFavorite(id, starElement) {
            if (favorites.includes(id)) {
                favorites = favorites.filter(favId => favId !== id);
                starElement.classList.remove('active');
            } else {
                favorites.push(id);
                starElement.classList.add('active');
            }
            saveFavorites();
        }

        // --- 遅延読み込み機能 ---
        function setupVideoObserver() {
            videoObserver = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const video = entry.target;
                        video.src = video.dataset.src;
                        observer.unobserve(video);
                    }
                });
            }, { rootMargin: "0px 0px 200px 0px" }); // 画面に入る200px手前から読み込み開始
        }
        
        // --- 表示更新・補助関数 ---
        
        function populateSelect(selectElement, options, placeholder) {
            const currentValue = selectElement.value;
            selectElement.innerHTML = '';
            
            const placeholderOption = document.createElement('option');
            placeholderOption.value = "";
            placeholderOption.textContent = placeholder;
            selectElement.appendChild(placeholderOption);

            options.forEach(optionText => {
                const option = document.createElement('option');
                option.value = optionText;
                option.textContent = optionText;
                selectElement.appendChild(option);
            });

            if (options.includes(currentValue)) {
                selectElement.value = currentValue;
            }
        }

        function filterAndDisplayResults() {
            const selectedCourse = courseSelect.value;
            const selectedDestination = destinationSelect.value;
            let results = [];

            if (selectedCourse && selectedDestination) {
                const courseData = shortcutData.find(c => c.course === selectedCourse);
                if (courseData) {
                    const shortcut = courseData.shortcuts.find(s => s.name === selectedDestination);
                    if (shortcut) results.push({ ...shortcut, courseName: selectedCourse });
                }
            } else if (selectedCourse) {
                const courseData = shortcutData.find(c => c.course === selectedCourse);
                if (courseData) results = courseData.shortcuts.map(s => ({ ...s, courseName: selectedCourse }));
            } else if (selectedDestination) {
                shortcutData.forEach(course => {
                    course.shortcuts.forEach(shortcut => {
                        if (shortcut.name === selectedDestination) {
                            results.push({ ...shortcut, courseName: course.course });
                        }
                    });
                });
            }

            if (results.length > 0) {
                displayAllResults(results);
            } else {
                hideResult();
            }
        }
        
        function displayAllResults(shortcutsArray) {
            resultContent.innerHTML = '';
            if (shortcutsArray.length === 0) {
                hideResult();
                resultPlaceholder.textContent = "該当するショートカットはありません。";
                return;
            }

            shortcutsArray.forEach(shortcut => {
                const shortcutId = `${shortcut.courseName}-${shortcut.name}`;
                const isFav = favorites.includes(shortcutId);

                const shortcutContainer = document.createElement('div');
                const titleText = shortcut.courseName ? `${shortcut.courseName} → ${shortcut.name}` : shortcut.name;

                const titleContainer = document.createElement('div');
                titleContainer.className = "flex justify-between items-center mb-4 pb-2 border-b-2 border-blue-200";
                
                const titleElement = document.createElement('h2');
                titleElement.className = "text-2xl font-bold";
                titleElement.textContent = titleText;

                const starElement = document.createElement('span');
                starElement.className = `favorite-star ${isFav ? 'active' : ''}`;
                starElement.innerHTML = '&#9733;'; // ★
                starElement.dataset.id = shortcutId;
                starElement.addEventListener('click', () => toggleFavorite(shortcutId, starElement));

                titleContainer.appendChild(titleElement);
                titleContainer.appendChild(starElement);
                shortcutContainer.appendChild(titleContainer);

                const methodsContainer = document.createElement('div');
                const gridColsClass = shortcut.methods.length > 1 ? 'md:grid-cols-2' : 'md:grid-cols-1';
                methodsContainer.className = `grid grid-cols-1 ${gridColsClass} gap-6`;

                shortcut.methods.forEach(method => {
                    let videoElementHTML = '';
                    if (method.videoType === 'youtube') {
                        videoElementHTML = `<iframe class="absolute top-0 left-0 w-full h-full lazy-video" data-src="https://www.youtube.com/embed/${method.videoSource}" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
                    } else if (method.videoType === 'mp4') {
                        videoElementHTML = `<video class="absolute top-0 left-0 w-full h-full object-cover lazy-video" data-src="${method.videoSource}" controls autoplay muted loop playsinline>お使いのブラウザは動画の再生に対応していません。</video>`;
                    }

                    const methodHTML = `
                        <div>
                            <h3 class="text-xl font-bold mb-3 text-gray-800">${method.type}</h3>
                            <div class="aspect-w-16 mb-4 rounded-lg overflow-hidden shadow-md bg-black">
                                ${videoElementHTML}
                            </div>
                            <p class="text-gray-700 leading-relaxed whitespace-pre-wrap">${method.description || ' '}</p>
                        </div>
                    `;
                    methodsContainer.innerHTML += methodHTML;
                });
                shortcutContainer.appendChild(methodsContainer);
                resultContent.appendChild(shortcutContainer);
            });

            // 遅延読み込みの対象を監視
            document.querySelectorAll('.lazy-video').forEach(video => videoObserver.observe(video));

            resultPlaceholder.classList.add('hidden');
            resultContent.classList.remove('hidden');
        }

        function hideResult() {
            resultPlaceholder.textContent = "ここに選択したショートカットの情報が表示されます。";
            resultPlaceholder.classList.remove('hidden');
            resultContent.classList.add('hidden');
            resultContent.innerHTML = '';
        }
    </script>
</body>
</html>

